<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basilicata River AI | Control Room</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Inter', sans-serif; background: #0b0e11; }
        #map { height: 100vh; width: 100%; }
        .glass-panel {
            position: absolute; z-index: 1000; background: rgba(11, 14, 17, 0.9);
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
            color: white; padding: 20px; border-radius: 15px;
        }
        .top-left { top: 20px; left: 20px; width: 280px; }
        .status-dot { height: 10px; width: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px #2ecc71; }
    </style>
</head>
<body>

    <div class="glass-panel top-left">
        <div d-flex align-items-center><span class="status-dot"></span> <b>LIVE MONITOR</b></div>
        <h3 style="margin: 10px 0 5px 0; font-size: 1.2rem;">Basilicata River AI</h3>
        <hr style="opacity: 0.1">
        <small id="update-time">Caricamento dati...</small>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([40.5, 16.2], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        // Funzione per caricare i dati dal JSON generato da Python
        async function loadData() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();
                
                document.getElementById('update-time').innerText = "Ultimo aggiornamento: " + data.last_update;

                // Icona per le Dighe
                const damIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div style='background-color:#4285F4; padding:5px; border-radius:50%; border:2px solid white; color:white; text-align:center;'><i class='fa fa-industry' style='font-size:10px;'></i></div>",
                    iconSize: [24, 24]
                });

                // Posiziona Dighe
                data.dighe.forEach(d => {
                    L.marker([d.lat, d.lon], {icon: damIcon}).addTo(map)
                     .bindPopup(`<b>${d.nome}</b><br>Volume: ${d.volume} Mmc<br>Riempimento: ${d.percentuale}%`);
                });

                // Posiziona Fiumi
                data.fiumi.forEach(f => {
                    let color = "#3498db";
                    if(f.livello !== "N/D" && parseFloat(f.livello) > 1.5) color = "red";
                    
                    L.circleMarker([f.lat, f.lon], {
                        radius: 8, color: 'white', weight: 1, fill: true, fillColor: color, fillOpacity: 0.8
                    }).addTo(map).bindPopup(`
                        <b>${f.stazione}</b><br>Fiume: ${f.fiume}<br>Livello: <b>${f.livello}</b><br>
                        <div style="margin-top:8px; padding:5px; background:#f0f7ff; border-radius:4px; color:#4285F4; font-size:11px;">
                        <b>GOOGLE AI:</b> ${f.ai_risk}</div>
                    `);
                });

            } catch (e) { console.error("Errore caricamento JSON:", e); }
        }

        loadData();
    </script>
</body>
</html>
