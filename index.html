<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Room Basilicata | Multi-Source AI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0b0e11; font-family: 'Inter', sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        .glass { position: absolute; z-index: 1000; background: rgba(11, 14, 17, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 12px; }
        .top-left { top: 20px; left: 20px; }
        .legend { bottom: 30px; left: 20px; font-size: 11px; }
        
        /* Forme Custom */
        .marker-google { border-radius: 4px !important; } /* Quadrato */
        .marker-regione { border-radius: 50% !important; } /* Cerchio */
        
        .chart-box { width: 220px; height: 110px; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="glass top-left">
        <h4 style="margin:0; color:#4285F4;"><i class="fa fa-shield-halved"></i> BASILICATA RIVER MONITOR</h4>
        <small id="update-time">Caricamento...</small>
    </div>

    <div class="glass legend">
        <div style="margin-bottom:5px"><b>LEGENDA SENSORI</b></div>
        <div><i class="fa fa-circle" style="color:#3498db"></i> Sensore Regione (OK)</div>
        <div><i class="fa fa-square" style="color:#4285F4"></i> Sensore Google AI (OK)</div>
        <div><i class="fa fa-circle" style="color:#e74c3c"></i> ALLERTA RILEVATA</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([40.5, 16.2], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function load() {
            const r = await fetch('data.json?t=' + Date.now());
            const data = await r.json();
            document.getElementById('update-time').innerText = "Ultimo aggiornamento: " + data.last_update;

            data.stazioni.forEach(s => {
                let color = s.source === "REGIONE" ? "#3498db" : "#4285F4";
                if(s.warning) color = "#e74c3c";

                // Differenziazione Forma
                const markerHtml = `<div style="background:${color}; width:12px; height:12px; border:2px solid white; ${s.source === 'GOOGLE' ? 'border-radius:2px;' : 'border-radius:50%;'}"></div>`;
                
                const marker = L.marker([s.lat, s.lon], {
                    icon: L.divIcon({ html: markerHtml, className: 'custom-marker', iconSize: [14, 14] })
                }).addTo(map);

                // Popup differenziato
                if(s.source === "REGIONE") {
                    marker.bindPopup(`<b>${s.nome}</b><br>Sorgente: Regione<br>Livello: <b>${s.livello}</b>`);
                } else {
                    const cid = `c-${Math.random().toString(36).substr(2, 9)}`;
                    marker.bindPopup(`
                        <div style="width:230px; color:black">
                            <h5 style="margin:0">Google Flood AI</h5>
                            <small>${s.nome}</small><hr>
                            <b>Rischio: ${s.severity}</b>
                            <div class="chart-box"><canvas id="${cid}"></canvas></div>
                            <a href="${s.link}" target="_blank" style="font-size:10px">Dettagli FloodHub â†’</a>
                        </div>
                    `);
                    marker.on('popupopen', () => {
                        new Chart(document.getElementById(cid), {
                            type: 'line',
                            data: {
                                labels: ['+1g','+3g','+5g','+7g'],
                                datasets: [{ data: s.forecast, borderColor: '#4285F4', fill: true, backgroundColor: 'rgba(66,133,244,0.1)', tension: 0.4 }]
                            },
                            options: { plugins: { legend: {display:false} }, scales: { y: {display:false} } }
                        });
                    });
                }
            });

            // Dighe con fix riempimento
            data.dighe.forEach(d => {
                const damIcon = L.divIcon({
                    html: `<div style="background:#1a73e8; color:white; padding:3px 6px; border-radius:4px; border:1px solid white; font-size:9px;">${d.percentuale}%</div>`,
                    className: 'dam-lbl', iconSize: [35, 18]
                });
                L.marker([d.lat, d.lon], {icon: damIcon}).addTo(map)
                 .bindPopup(`<b>Diga: ${d.nome}</b><br>Volume: ${d.volume} Mmc<br>Riempimento: ${d.percentuale}%`);
            });
        }
        load();
    </script>
</body>
</html>
