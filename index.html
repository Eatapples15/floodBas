<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Basilicata River AI | Control Room</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0b0e11; font-family: sans-serif; color: white; }
        #map { height: 100vh; width: 100%; }
        .panel { position: absolute; z-index: 1000; background: rgba(15, 20, 25, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; }
        .top-left { top: 20px; left: 20px; width: 300px; }
        .sidebar { top: 20px; right: 20px; width: 280px; max-height: 80vh; overflow-y: auto; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .bg-danger { background: #ff4d4d; }
        .river-item { border-left: 3px solid #4285F4; background: rgba(255,255,255,0.05); margin-bottom: 8px; padding: 8px; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="panel top-left">
        <h3 style="margin:0; color:#4285F4;"><i class="fa fa-robot"></i> RIVER AI</h3>
        <small id="update-time">Inizializzazione...</small>
        <hr style="opacity:0.1">
        <div id="summary">Monitoraggio Basilicata</div>
    </div>

    <div class="panel sidebar">
        <h5 style="margin:0 0 10px 0;">ALLERTE GOOGLE FLOOD</h5>
        <div id="alerts"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/python-visualization/folium@main/folium/templates/leaflet_heat.min.js"></script>

    <script>
        const map = L.map('map', { zoomControl: false }).setView([40.5, 16.2], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function load() {
            try {
                const r = await fetch('data.json');
                if (!r.ok) throw new Error("JSON non pronto");
                const data = await r.json();

                document.getElementById('update-time').innerText = "Update: " + data.last_update;

                // Layer GRIB Heatmap
                L.heatLayer(data.grib_points, {radius: 25, minOpacity: 0.2}).addTo(map);

                // Sensori Fiumi
                data.fiumi.forEach(f => {
                    let color = "#3498db";
                    if(f.google.severity !== "NORMALE") color = "#ff4d4d";

                    const m = L.circleMarker([f.lat, f.lon], {
                        radius: 8, color: 'white', weight: 1, fill: true, fillColor: color, fillOpacity: 0.8
                    }).addTo(map);

                    m.bindPopup(`
                        <div style="color:black; min-width:200px">
                            <h4 style="margin:0">${f.stazione}</h4>
                            <b>Livello: ${f.livello}</b><hr>
                            <div style="background:#e8f0fe; padding:10px; border-radius:5px; border-left:4px solid #4285F4">
                                <b style="color:#4285F4">GOOGLE FLOOD HUB</b><br>
                                Rischio: ${f.google.severity}<br>
                                <a href="${f.google.link}" target="_blank">Apri Previsioni AI â†’</a>
                            </div>
                        </div>
                    `);

                    if(f.google.severity !== "NORMALE") {
                        const div = document.createElement('div');
                        div.className = 'river-item';
                        div.innerHTML = `<b>${f.stazione}</b><br><span class="badge bg-danger">${f.google.severity}</span>`;
                        document.getElementById('alerts').appendChild(div);
                    }
                });

                // Dighe
                data.dighe.forEach(d => {
                    L.marker([d.lat, d.lon], {
                        icon: L.divIcon({html: '<i class="fa fa-industry" style="color:#1a73e8; font-size:20px;"></i>', className: 'd-icon'})
                    }).addTo(map).bindPopup(`<div style="color:black"><b>${d.nome}</b><br>Riempimento: ${d.percentuale}%</div>`);
                });

            } catch (e) { 
                document.getElementById('update-time').innerText = "In attesa del primo deploy...";
            }
        }
        load();
    </script>
</body>
</html>
