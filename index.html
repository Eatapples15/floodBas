<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Control Room Basilicata | AI Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body, html { margin:0; padding:0; height:100%; background:#0b0e11; font-family:sans-serif; color:white; }
        #map { height: 100vh; width: 100%; }
        .glass { position:absolute; z-index:1000; background:rgba(15,20,25,0.9); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); padding:15px; border-radius:12px; }
        .top-left { top:20px; left:20px; border-top:3px solid #4285F4; }
        
        /* Marker Styles */
        .m-regione { background:#3498db; width:12px; height:12px; border:2px solid white; border-radius:50%; }
        .m-google { background:#4285F4; width:14px; height:14px; border:2px solid white; border-radius:3px; display:flex; align-items:center; justify-content:center; }
        .m-google i { color:white; font-size:8px; }
        .m-alert { background:#ea4335 !important; box-shadow: 0 0 10px #ea4335; }

        .legend { bottom:30px; left:20px; font-size:11px; }
        .chart-box { width:220px; height:100px; margin-top:10px; }
        .leaflet-popup-content { color: #333; }
    </style>
</head>
<body>
    <div class="glass top-left">
        <h3 style="margin:0; font-size:1.2rem">COMMAND CENTER</h3>
        <small id="update-time">Inizializzazione...</small>
    </div>

    <div class="glass legend">
        <b>SORGENTI DATI</b><br>
        <i class="fa fa-circle" style="color:#3498db"></i> Sensore Regione (Tondo)<br>
        <i class="fa fa-square" style="color:#4285F4"></i> Google AI (Quadrato)<br>
        <i class="fa fa-circle" style="color:#ea4335"></i> Allerta Critica (L3 / Extreme)
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([40.55, 16.2], 9);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function init() {
            try {
                const res = await fetch('data.json?t=' + Date.now());
                const data = await res.json();
                document.getElementById('update-time').innerText = "Live: " + data.last_update;

                data.stazioni.forEach(s => {
                    let className = s.source === "GOOGLE" ? "m-google" : "m-regione";
                    if(s.status === "PERICOLO" || (s.severity && s.severity !== "NORMALE")) className += " m-alert";

                    const marker = L.marker([s.lat, s.lon], {
                        icon: L.divIcon({ html: s.source === "GOOGLE" ? `<div class="${className}"><i class="fab fa-google"></i></div>` : `<div class="${className}"></div>`, className: 'custom-marker', iconSize:[16,16] })
                    }).addTo(map);

                    if(s.source === "REGIONE") {
                        marker.bindPopup(`<b>${s.nome}</b><br>Livello: <b>${s.livello}</b>`);
                    } else {
                        const cid = `c-${Math.random().toString(36).substr(2,5)}`;
                        marker.bindPopup(`<div style="width:230px"><b>GOOGLE FLOODHUB</b><br><small>${s.nome}</small><div class="chart-box"><canvas id="${cid}"></canvas></div><a href="${s.link}" target="_blank" style="font-size:10px">Vedi Previsioni AI â†’</a></div>`);
                        marker.on('popupopen', () => {
                            new Chart(document.getElementById(cid), {
                                type: 'line',
                                data: { labels: ['+1','+3','+5','+7'], datasets: [{ data: s.forecast, borderColor:'#4285F4', tension:0.4, fill:true, backgroundColor:'rgba(66,133,244,0.1)' }] },
                                options: { plugins:{legend:{display:false}}, scales:{y:{display:false}} }
                            });
                        });
                    }
                });

                data.dighe.forEach(d => {
                    const icon = L.divIcon({
                        html: `<div style="background:#1a73e8; color:white; padding:2px 5px; border-radius:4px; font-size:9px; border:1px solid white">${d.percentuale}%</div>`,
                        className: 'd-lbl', iconSize:[38,18]
                    });
                    L.marker([d.lat, d.lon], {icon: icon}).addTo(map)
                     .bindPopup(`<b>Diga ${d.nome}</b><br>Riempimento: ${d.percentuale}%`);
                });
            } catch (e) { console.error(e); }
        }
        init();
    </script>
</body>
</html>
